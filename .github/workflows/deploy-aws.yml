name: CI - Pipeline

# When to run the workflow
on: push
jobs:
   project-testing:
      runs-on: ubuntu-latest

      steps:
        - name: checkout code
          uses: actions/checkout@v4
        - name: setup python
          uses: actions/setup-python@v4
          with:
              python-version:  '3.12.3'
        - name: Cache pip dependencies
          uses: actions/cache@v4
          with:
            path: ~/.cache/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
            restore-keys: |
              ${{ runner.os }}-pip-

        - name: install dependencies
          run:  |
            pip install -r requirements.txt
        - name: run pipeline
          env:
            DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN}}
          run: |
            dvc repro
        - name: run tests
          env:
             DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN}}
          run: |
            python -m unittest scripts/test_model.py
        
        - name: promote model to production
          if: success()
          env:
            DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN}}
          run: |
            python scripts/promote_model.py
        - name: run Flask app tests
          env:
            DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN}}
            DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME}}
          run: |
            cd CommentAnaysisExtension/backend
            pip install -r requirements.txt
            python -m unittest tests.test_app -v
        



